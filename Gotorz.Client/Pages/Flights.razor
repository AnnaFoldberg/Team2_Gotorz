@page "/flights"
@using Gotorz.Shared.Models
@using System.ComponentModel.DataAnnotations
@using System.Text.Json
@using Microsoft.AspNetCore.Mvc
@using Gotorz.Client.Services
@inject FlightService FlightService
@inject ILogger<Flights> Logger

<EditForm Model="@searchForm" OnValidSubmit="Search">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="container">
        <div class="d-flex gap-2 align-items-end">
            <div class="form-group flex-grow-1">
                <label for="departureAirport" class="form-label">Departure Airport</label>
                <InputText class="form-control" id="departureAirport" @bind-Value="searchForm.departureAirport" list="departure-options" />
                <datalist id="departure-options">
                    @foreach (var name in airportNames)
                    {
                        <option value="@name"></option>
                    }
                </datalist>
            </div>
            <div class="form-group flex-grow-1">
                <label for="arrivalAirport" class="form-label">Arrival Airport</label>
                <InputText class="form-control" id="arrivalAirport" @bind-Value="searchForm.arrivalAirport" list="departure-options" />
                <datalist id="departure-options">
                    @foreach (var name in airportNames)
                    {
                        <option value="@name"></option>
                    }
                </datalist>
            </div>
            <div class="form-group flex-grow-1">
                <label for="date" class="form-label">Date (optional)</label>
                <InputText class="form-control" id="date" @bind-Value="searchForm.date" placeholder="dd-MM-yyyy"/>
            </div>
            <div class="form-group flex-grow-1">
                <button type="submit" class="btn icon-white h-100 custom-background text-white bi bi-search"></button>
            </div>
        </div>
    </div>
</EditForm>

<br><br>

@if (flights != null && searchPerformed)
{
    if (flights.Any())
    {
        <ul class="list-group">
            <li class="list-group-item d-flex justify-content-between align-items-center text-white custom-background">
                <span class="col">Date</span>
                <span class="col">Departure</span>
                <span class="col">Arrival</span>
                @* <span class="col">Price</span> *@
            </li>

            @foreach (var flight in flights)
            {
                var departureAirport = airports.FirstOrDefault(a => a.AirportId == flight.DepartureAirportId);
                var arrivalAirport = airports.FirstOrDefault(a => a.AirportId == flight.ArrivalAirportId);

                <li class="list-group-item d-flex justify-content-between align-items-center" >
                    @* @onclick="() => SelectFlight(flight)"> *@
                    <span class="col">@flight.DepartureDate.ToString("dd-MM-yyyy")</span>
                    <span class="col">@departureAirport.LocalizedName</span>
                    <span class="col">@arrivalAirport.LocalizedName</span>
                    @* <span class="col">@flight.Price.ToString("C")</span> *@
                </li>
            }
        </ul>
    }
    else
    {
        <h6>No flights were found</h6>
    }
}

@* @if (flightSelected && selectedFlight != null)
{
    <p>You selected flight @selectedFlight.FlightNumber</p>
} *@

@code {
    private bool searchPerformed = false;
    private SearchForm searchForm = new SearchForm();
    private IEnumerable<Airport> airports = Enumerable.Empty<Airport>();
    private IEnumerable<string> airportNames = Enumerable.Empty<string>();
    private List<Flight>? flights = new List<Flight>();
    @* private Flight? selectedFlight;
    private bool flightSelected = false; *@

    public class SearchForm
    {
        [DateFormat("dd-MM-yyyy")]
        public string? date { get; set; }

        [Required(ErrorMessage = "Departure airport is required.")]
        public string departureAirport { get; set; }= string.Empty;

        [Required(ErrorMessage = "Arrival airport is required.")]
        public string arrivalAirport { get; set; }= string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        airports = await FlightService.GetAllAirports();
        airportNames = airports.Select(a => a.LocalizedName);
    }

    private async Task Search()
    {
        try
        {
            var result = await FlightService.GetFlights(searchForm.date, searchForm.departureAirport, searchForm.arrivalAirport);

            if (result == null)
            {
                flights = new List<Flight>();
                return;
            }

            flights = result;

            airports = await FlightService.GetAllAirports();
            airportNames = airports.Select(a => a.LocalizedName);

            searchPerformed = true;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error fetching flights");
        }
    }

    @* private async Task SelectFlight(Flight flight)
    {
        selectedFlight = flight;
        flightSelected = true;
    } *@
}
